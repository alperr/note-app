<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attachment List</title>
    <link href="bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <button id="uploadBtn" class="btn btn-primary mb-3">Upload Attachment</button>
    <div id="attachmentList"></div>

    <script>
        const API_BASE = 'http://localhost:3000';

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function fetchAttachments() {
            try {
                const response = await fetch(`${API_BASE}/attachments`);
                const attachments = await response.json();
                displayAttachments(attachments);
            } catch (error) {
                console.error('Error fetching attachments:', error);
            }
        }

        function displayAttachments(attachments) {
            const attachmentList = document.getElementById('attachmentList');
            attachmentList.innerHTML = `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `;
            const tbody = attachmentList.querySelector('tbody');
            attachments.forEach(attachment => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';

                const nameCell = document.createElement('td');
                nameCell.textContent = attachment.name;
                row.appendChild(nameCell);

                const typeCell = document.createElement('td');
                typeCell.textContent = attachment.mime_type;
                row.appendChild(typeCell);

                const sizeCell = document.createElement('td');
                sizeCell.textContent = formatBytes(attachment.size);
                row.appendChild(sizeCell);

                const createdCell = document.createElement('td');
                const date = attachment.saved_at ? new Date(attachment.saved_at) : null;
                createdCell.textContent = date && !isNaN(date) ? date.toLocaleString() : 'Unknown';
                row.appendChild(createdCell);

                row.onclick = () => {
                    fetch(`${API_BASE}/attachments/${attachment.id}`)
                        .then(res => res.json())
                        .then(data => {
                            const blob = new Blob([Uint8Array.from(atob(data.content), c => c.charCodeAt(0))], { type: data.mime_type });
                            const url = URL.createObjectURL(blob);
                            window.location.href = url;
                        });
                };
                tbody.appendChild(row);
            });
        }

        document.getElementById('uploadBtn').onclick = () => {
            window.location.href = 'upload-attachment.html';
        };

        fetchAttachments();
    </script>
<script src="bootstrap.bundle.min.js"></script>
</body>
</html>