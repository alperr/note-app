<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Note</title>
    <link href="bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <h1 class="mb-4">Edit Note</h1>
    <form id="noteForm" class="mb-4">
        <input type="text" id="name" class="form-control" required>

        <textarea id="content" class="form-control" rows="10"></textarea>

        <button type="button" id="manageAttachments">Manage Attachments</button><br><br>

        <button type="submit" class="btn btn-primary">Save</button>
    </form>

    <div class="modal fade" id="attachmentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Attachments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="attachmentsList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAttachments">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');
        let currentAttachments = [];

        async function loadNote() {
            if (noteId) {
                try {
                    const response = await fetch(`${API_BASE}/notes/${noteId}`);
                    const note = await response.json();
                    document.getElementById('name').value = note.name;
                    document.getElementById('content').value = note.content;
                    currentAttachments = note.attachments || [];
                } catch (error) {
                    console.error('Error loading note:', error);
                }
            } else {
                currentAttachments = [];
            }
        }

        document.getElementById('noteForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const content = document.getElementById('content').value;
            const attachments = currentAttachments;

            const noteData = { name, content, attachments };

            try {
                let response;
                if (noteId) {
                    response = await fetch(`${API_BASE}/notes/${noteId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(noteData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const newNote = await response.json();
                    // For new note, update with content and attachments
                    await fetch(`${API_BASE}/notes/${newNote.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(noteData)
                    });
                }
                if (response.ok) {
                    alert('Note saved!');
                    window.location.href = 'note-list.html';
                } else {
                    alert('Error saving note');
                }
            } catch (error) {
                console.error('Error saving note:', error);
            }
        };

        async function openAttachmentsModal() {
            try {
                const response = await fetch(`${API_BASE}/attachments`);
                const attachments = await response.json();
                const list = document.getElementById('attachmentsList');
                list.innerHTML = `
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                `;
                const tbody = list.querySelector('tbody');
                attachments.forEach(att => {
                    const row = document.createElement('tr');
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = att.id;
                    checkbox.checked = currentAttachments.includes(att.id);
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    const nameCell = document.createElement('td');
                    nameCell.textContent = att.name;
                    row.appendChild(nameCell);

                    const typeCell = document.createElement('td');
                    typeCell.textContent = att.mime_type;
                    row.appendChild(typeCell);

                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = formatBytes(att.size);
                    row.appendChild(sizeCell);

                    const createdCell = document.createElement('td');
                    const date = att.saved_at ? new Date(att.saved_at) : null;
                    createdCell.textContent = date && !isNaN(date) ? date.toLocaleString() : 'Unknown';
                    row.appendChild(createdCell);

                    tbody.appendChild(row);
                });
                const modal = new bootstrap.Modal(document.getElementById('attachmentsModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading attachments:', error);
            }
        }

        function saveAttachments() {
            const checkboxes = document.querySelectorAll('#attachmentsList input[type="checkbox"]');
            currentAttachments = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const modal = bootstrap.Modal.getInstance(document.getElementById('attachmentsModal'));
            modal.hide();
        }

        document.getElementById('manageAttachments').onclick = openAttachmentsModal;
        document.getElementById('saveAttachments').onclick = saveAttachments;

        loadNote();
    </script>
<script src="bootstrap.bundle.min.js"></script>
</body>
</html>